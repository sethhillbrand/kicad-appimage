workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "web" || $CI_PIPELINE_SOURCE == "schedule"'

variables:
  # Version pins for reproducible builds
  WX_VERSION: "3.2.8.1"
  OCCT_VERSION: "V7_9_1"
  WXPYTHON_VERSION: "4.2.3"
  NGSPICE_VERSION: "44.2"
  S5CMD_VERSION: "2.0.0"
  # Docker TLS configuration for buildx
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"

stages:
  - build
  - upload

# ============================================================================
# SHARED RULES AND TEMPLATES
# ============================================================================

# Base rules for foundational jobs (schedule: always, manual: manual)
.base_rules: &base_rules
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - when: manual

# Standard dependency rules (always run when dependencies succeed)
.dependency_rules: &dependency_rules
  rules:
    - when: on_success

# Template for jobs that need sequential scheduling but manual independence
.sequential_job_template: &sequential_job_template
  stage: build
  # Individual jobs override rules with specific needs for schedule vs manual

# ============================================================================
# BUILD JOBS
# ============================================================================

default:
  tags:
    - kicad-dind
  image: docker:28
  services:
    - docker:28-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker context create ki-builder
    - docker buildx create ki-builder --driver docker-container --use
    - docker buildx inspect --bootstrap

# Shared rules for dependency builds
.dependency_rules: &dependency_rules
  rules:
    - when: on_success

# Base image - foundational dependencies
build-base:
  <<: *base_rules
  stage: build
  script:
    - BASE_TAG="base-$(date +%Y%m%d)-$CI_COMMIT_SHORT_SHA"
    - IMAGE_NAME="$CI_REGISTRY_IMAGE/base:$BASE_TAG"
    # Check if we need to rebuild
    - |
      if docker manifest inspect $CI_REGISTRY_IMAGE/base:latest >/dev/null 2>&1 && [ "$FORCE_REBUILD" != "true" ]; then
        echo "Base image exists and no forced rebuild, skipping"
        exit 0
      fi
    - docker build -t $IMAGE_NAME -f docker/Dockerfile.base .
    - docker tag $IMAGE_NAME $CI_REGISTRY_IMAGE/base:latest
    - docker push $IMAGE_NAME
    - docker push $CI_REGISTRY_IMAGE/base:latest

# wxWidgets - version-pinned rebuild
build-wx:
  <<: *sequential_job_template
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      needs: ["build-base"]
    - when: manual
      needs: []
  script:
    - WX_TAG="wx-$WX_VERSION"
    - IMAGE_NAME="$CI_REGISTRY_IMAGE/wx:$WX_TAG"
    # Check if this version already exists
    - |
      if docker manifest inspect $IMAGE_NAME >/dev/null 2>&1 && [ "$FORCE_REBUILD" != "true" ]; then
        echo "wxWidgets $WX_VERSION already built, syncing latest tag (remote)"
        docker buildx imagetools create --tag "$CI_REGISTRY_IMAGE/wx:latest" "$IMAGE_NAME"
        exit 0
      fi
    - docker build --build-arg BASE_IMAGE=$CI_REGISTRY_IMAGE/base:latest --build-arg WX_VERSION=$WX_VERSION -t $IMAGE_NAME -f docker/Dockerfile.wx .
    - docker tag $IMAGE_NAME $CI_REGISTRY_IMAGE/wx:latest
    - docker push $IMAGE_NAME
    - docker push $CI_REGISTRY_IMAGE/wx:latest

# wxPython - depends on wx
build-wxpython:
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      needs: ["build-base", "build-wx"]
    - when: manual
      needs: []
  script:
    - WXPY_TAG="wxpython-$WXPYTHON_VERSION"
    - IMAGE_NAME="$CI_REGISTRY_IMAGE/wxpython:$WXPY_TAG"
    # Check if this version already exists
    - |
      if docker manifest inspect $IMAGE_NAME >/dev/null 2>&1 && [ "$FORCE_REBUILD" != "true" ]; then
        echo "wxPython $WXPYTHON_VERSION already built, syncing latest tag (remote)"
        docker buildx imagetools create --tag "$CI_REGISTRY_IMAGE/wxpython:latest" "$IMAGE_NAME"
        exit 0
      fi
    - docker build --build-arg BASE_IMAGE=$CI_REGISTRY_IMAGE/base:latest --build-arg WX_IMAGE=$CI_REGISTRY_IMAGE/wx:latest --build-arg WXPYTHON_VERSION=$WXPYTHON_VERSION -t $IMAGE_NAME -f docker/Dockerfile.wxpython .
    - docker tag $IMAGE_NAME $CI_REGISTRY_IMAGE/wxpython:latest
    - docker push $IMAGE_NAME
    - docker push $CI_REGISTRY_IMAGE/wxpython:latest

# OCCT - version-pinned rebuild
build-occt:
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      needs: ["build-base"]
    - when: manual
      needs: []
  script:
    - OCCT_TAG="occt-$OCCT_VERSION"
    - IMAGE_NAME="$CI_REGISTRY_IMAGE/occt:$OCCT_TAG"
    # Check if this version already exists
    - |
      if docker manifest inspect $IMAGE_NAME >/dev/null 2>&1 && [ "$FORCE_REBUILD" != "true" ]; then
        echo "OCCT $OCCT_VERSION already built, syncing latest tag (remote)"
        docker buildx imagetools create --tag "$CI_REGISTRY_IMAGE/occt:latest" "$IMAGE_NAME"
        exit 0
      fi
    - git clone --depth=1 https://github.com/Open-Cascade-SAS/OCCT.git --branch=${OCCT_BRANCH:-$OCCT_VERSION} occt || exit 1
    - docker build --build-context occt-src=occt --build-arg BASE_IMAGE=$CI_REGISTRY_IMAGE/base:latest -t $IMAGE_NAME -f docker/Dockerfile.occt .
    - docker tag $IMAGE_NAME $CI_REGISTRY_IMAGE/occt:latest
    - docker push $IMAGE_NAME
    - docker push $CI_REGISTRY_IMAGE/occt:latest

# ngspice - git hash-based rebuild
build-ngspice:
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      needs: ["build-base"]
    - when: manual
      needs: []
  script:
    - NGSPICE_TAG="ngspice-$NGSPICE_VERSION"
    - IMAGE_NAME="$CI_REGISTRY_IMAGE/ngspice:$NGSPICE_TAG"
    # Check if this version already exists
    - |
      if docker manifest inspect $IMAGE_NAME >/dev/null 2>&1 && [ "$FORCE_REBUILD" != "true" ]; then
        echo "ngspice $NGSPICE_VERSION already built, syncing latest tag (remote)"
        docker buildx imagetools create --tag "$CI_REGISTRY_IMAGE/ngspice:latest" "$IMAGE_NAME"
        exit 0
      fi
    - git clone --depth=1 https://git.code.sf.net/p/ngspice/ngspice.git --branch=$NGSPICE_VERSION ngspice || exit 1
    - docker build --build-context ngspice-src=ngspice --build-arg BASE_IMAGE=$CI_REGISTRY_IMAGE/base:latest -t $IMAGE_NAME -f docker/Dockerfile.ngspice .
    - docker tag $IMAGE_NAME $CI_REGISTRY_IMAGE/ngspice:latest
    - docker push $IMAGE_NAME
    - docker push $CI_REGISTRY_IMAGE/ngspice:latest

# KiCad libraries - rebuild on schedule or manual
build-libs:
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      needs: ["build-base"]
    - when: manual
      needs: []
  script:
    - LIBS_DATE=$(date +%Y%m%d)
    - LIBS_TAG="libs-$LIBS_DATE"
    - IMAGE_NAME="$CI_REGISTRY_IMAGE/libs:$LIBS_TAG"
    # Check if today's libraries are already built
    - |
      if docker manifest inspect $IMAGE_NAME >/dev/null 2>&1 && [ "$FORCE_REBUILD" != "true" ]; then
        echo "Libraries for $LIBS_DATE already built, syncing latest tag (remote)"
        docker buildx imagetools create --tag "$CI_REGISTRY_IMAGE/libs:latest" "$IMAGE_NAME"
        exit 0
      fi
    # Libraries change frequently, rebuild on schedule
    - git clone --depth=1 https://gitlab.com/kicad/libraries/kicad-symbols.git symbols || exit 1
    - git clone --depth=1 https://gitlab.com/kicad/libraries/kicad-footprints.git footprints || exit 1
    - git clone --depth=1 https://gitlab.com/kicad/libraries/kicad-templates.git templates || exit 1
    - docker build
      --build-context symbols-src=symbols
      --build-context footprints-src=footprints
      --build-context templates-src=templates
      --build-arg BASE_IMAGE=$CI_REGISTRY_IMAGE/base:latest -t $IMAGE_NAME -f docker/Dockerfile.libs .
    - docker tag $IMAGE_NAME $CI_REGISTRY_IMAGE/libs:latest
    - docker push $IMAGE_NAME
    - docker push $CI_REGISTRY_IMAGE/libs:latest

# 3D packages - rebuild on schedule or manual
build-packages3d:
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      needs: ["build-base"]
    - when: manual
      needs: []
  script:
    - PACKAGES_DATE=$(date +%Y%m%d)
    - PACKAGES_TAG="packages3d-$PACKAGES_DATE"
    - IMAGE_NAME="$CI_REGISTRY_IMAGE/packages3d:$PACKAGES_TAG"
    # Check if today's 3D packages are already built
    - |
      if docker manifest inspect $IMAGE_NAME >/dev/null 2>&1 && [ "$FORCE_REBUILD" != "true" ]; then
        echo "3D packages for $PACKAGES_DATE already built, syncing latest tag (remote)"
        docker buildx imagetools create --tag "$CI_REGISTRY_IMAGE/packages3d:latest" "$IMAGE_NAME"
        exit 0
      fi
    # 3D packages change frequently, rebuild on schedule
    - git clone --depth=1 https://gitlab.com/kicad/libraries/kicad-packages3D.git packages3d || exit 1
    - docker build --build-context packages3d-src=packages3d --build-arg BASE_IMAGE=$CI_REGISTRY_IMAGE/base:latest -t $IMAGE_NAME -f docker/Dockerfile.packages3d .
    - docker tag $IMAGE_NAME $CI_REGISTRY_IMAGE/packages3d:latest
    - docker push $IMAGE_NAME
    - docker push $CI_REGISTRY_IMAGE/packages3d:latest

# Final KiCad build - uses all pre-built dependencies
build-kicad:
  <<: *dependency_rules
  stage: build
  needs:
    - job: build-base
      optional: true
    - job: build-wx
      optional: true
    - job: build-wxpython
      optional: true
    - job: build-ngspice
      optional: true
    - job: build-occt
      optional: true
    - job: build-libs
      optional: true
    - job: build-packages3d
      optional: true
  before_script:
    # Install dependencies
    - apk update && apk add --no-cache patch git
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker context create ki-builder
    - docker buildx create ki-builder --driver docker-container --use
    - docker buildx inspect --bootstrap
    # Pull all dependency images
    - docker pull $CI_REGISTRY_IMAGE/base:latest || echo "Base image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/wx:latest || echo "WX image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/wxpython:latest || echo "wxPython image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/ngspice:latest || echo "ngspice image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/occt:latest || echo "OCCT image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/libs:latest || echo "Libs image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/packages3d:latest || echo "3D packages image not found, will build"
  script:
    - echo "CI_REGISTRY_IMAGE is '$CI_REGISTRY_IMAGE'"
    - echo "Registry arg will be '$CI_REGISTRY_IMAGE'"
    - git clone --shallow-since="60 days ago" https://gitlab.com/kicad/code/kicad.git --branch=${KICAD_BRANCH:-master} || exit 1
    - git clone https://github.com/sethhillbrand/appimage-builder.git && git --work-tree=./appimage-builder --git-dir=./appimage-builder/.git checkout fix-packaging-version-parse || exit 1
    - docker buildx build
      --progress=plain --build-context kicad-src=kicad
      --build-context appimage-builder-src=appimage-builder
      --build-arg REGISTRY=$CI_REGISTRY_IMAGE
      --build-arg BUILDKIT_CONTEXT_KEEP_GIT_DIR=1
      --build-arg KICAD_BUILD_RELEASE=nightly-$(date +%Y%m%d)
      --platform linux/amd64
      --target build-kicad
      --cache-to type=registry,ref=$CI_REGISTRY_IMAGE/cache:buildcache,mode=max
      --cache-from type=registry,ref=$CI_REGISTRY_IMAGE/cache:buildcache
      -o type=local,dest=.
      -f Dockerfile .
  artifacts:
    paths:
      - '*.AppImage'

build-kicad-light:
  <<: *dependency_rules
  stage: build
  needs:
    - job: build-kicad
      artifacts: true
    - job: build-base
      optional: true
    - job: build-wx
      optional: true
    - job: build-wxpython
      optional: true
    - job: build-ngspice
      optional: true
    - job: build-occt
      optional: true
    - job: build-libs
      optional: true
    - job: build-packages3d
      optional: true
  before_script:
    # Install dependencies
    - apk update && apk add --no-cache patch git
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker context create ki-builder
    - docker buildx create ki-builder --driver docker-container --use
    - docker buildx inspect --bootstrap
    # Pull all dependency images
    - docker pull $CI_REGISTRY_IMAGE/base:latest || echo "Base image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/wx:latest || echo "WX image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/wxpython:latest || echo "wxPython image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/ngspice:latest || echo "ngspice image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/occt:latest || echo "OCCT image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/libs:latest || echo "Libs image not found, will build"
    - docker pull $CI_REGISTRY_IMAGE/packages3d:latest || echo "3D packages image not found, will build"
  script:
    - echo "CI_REGISTRY_IMAGE is '$CI_REGISTRY_IMAGE'"
    - echo "Registry arg will be '$CI_REGISTRY_IMAGE'"
    - git clone --shallow-since="60 days ago" https://gitlab.com/kicad/code/kicad.git --branch=${KICAD_BRANCH:-master} || exit 1
    - git clone https://github.com/sethhillbrand/appimage-builder.git && git --work-tree=./appimage-builder --git-dir=./appimage-builder/.git checkout fix-packaging-version-parse || exit 1
    - docker buildx build
      --progress=plain --build-context kicad-src=kicad
      --build-context appimage-builder-src=appimage-builder
      --build-arg REGISTRY=$CI_REGISTRY_IMAGE
      --build-arg BUILDKIT_CONTEXT_KEEP_GIT_DIR=1
      --build-arg KICAD_BUILD_RELEASE=nightly-$(date +%Y%m%d)
      --platform linux/amd64
      --target build-kicad-light
      --cache-from type=registry,ref=$CI_REGISTRY_IMAGE/cache:buildcache
      -o type=local,dest=.
      -f Dockerfile .
  artifacts:
    paths:
      - '*.AppImage'

upload-kicad:
  <<: *dependency_rules
  stage: upload
  needs:
    - job: build-kicad
      artifacts: true
    - job: build-kicad-light
      artifacts: true
  image: alpine:latest
  services: []
  before_script:
    - apk add --no-cache s3cmd
  script:
    - for f in *.AppImage; do \
        s3cmd put --host s3.cern.ch --host-bucket '%(bucket)s.s3.cern.ch' \
          --access_key="$S3_ACCESS_KEY" --secret_key="$S3_SECRET_KEY" \
          "$f" "s3://kicad-downloads/$BUCKET_OUTPUT_PATH/"; \
      done